<?php
if (!isset($_SESSION)) {
    session_start();
}
if (isset($_COOKIE["log"])) {
    if ($_COOKIE["log"] == "week") {
        echo "<script>window.location.href ='main.php';</script>";
    }
}
date_default_timezone_set('Asia/Kathmandu');
?>

<!doctype html>
<html lang="en">

<head>
    <!-- <link href="sahakari_logo.png?v=<?php echo rand(); ?>" rel="icon"> -->
    <title>RFID</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/rfid.css">
    <link rel="stylesheet" href="css/addon.css">

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import {
            getDatabase,
            ref,
            set,
            child,
            equalTo,
            update,
            get,
            endAt,
            onValue,
            remove,
            query,
            onChildAdded,
            orderByChild,
        } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
        // import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";


        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCWnDZNJqlgWq-A1OFjb6c-kYAj6IDi630",
            authDomain: "narcs-1805c.firebaseapp.com",
            databaseURL: "https://narcs-1805c.firebaseio.com",
            projectId: "narcs-1805c",
            storageBucket: "narcs-1805c.appspot.com",
            messagingSenderId: "83689842797",
            appId: "1:83689842797:web:c1cc6cf94f28b7dadf3764"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        // const db = getFirestore(app);
        // var found = "true";

        var userreg = '';
        var unval = '';
        var uaval = '';
        var moval = '';
        var emval = '';
        var psdval = '';
        var cpsdval = '';

        async function checkEmail() {
            emval = document.getElementById('email').value;
            const dbRe = ref(database, `rfid/users/`);

            // // Query by email property
            const que = query(dbRe, orderByChild('email'), equalTo(emval));
            try {
                const snapshot = await get(que);
                if (snapshot.exists()) {
                    document.getElementById('emailspan').innerHTML = '❌ Email already exists';
                    document.getElementById('emailspans').innerHTML = '';
                    return false;
                } else {
                    console.log('No match - Email');
                    return true;
                }
            } catch (error) {
                console.error(error);
                return false;
            }
        }
        const emvalidate = document.getElementById("email");
        if (emvalidate != null) {
            emvalidate.addEventListener("change", checkEmail);
        }

        async function checkPhone() {
            moval = document.getElementById('mono').value;
            const dbRef = ref(database, `rfid/users/`);
            // // Query by email property
            const quer = query(dbRef, orderByChild('phone'), equalTo(moval));
            // async query
            try {
                const snapshot = await get(quer);
                if (snapshot.exists()) {
                    document.getElementById('mospan').innerHTML = '❌ Phone Number already exists';
                    document.getElementById('mospans').innerHTML = '';
                    return false;
                } else {
                    console.log('No match - Phone');
                    return true;
                }
            } catch (error) {
                console.error(error);
                return false;
            }
        }
        const movalidate = document.getElementById("mono");
        if (movalidate != null) {
            movalidate.addEventListener("change", checkPhone);
        }

        function sendOTP() {
            if (subva() == true) {
                let checkEm = await checkEmail();
                let checkPh = await checkPhone();
                console.log("checkEm - " + checkEm + typeof checkEm);
                console.log("checkPh - " + checkPh + typeof checkPh);
                if (checkEm == true) {
                    if (checkPh == true) {
                        emval = document.getElementById('email').value;
                        const min = 100000;
                        const max = 999999;
                        const randomCode = Math.floor(Math.random() * (max - min + 1)) + min;
                        const code = randomCode.toString();

                        let xhr = new XMLHttpRequest();
                        console.log(code);
                        xhr.open("POST", "send_mail.php", true);
                        xhr.onload = () => {
                            if (xhr.readyState === XMLHttpRequest.DONE) {
                                if (xhr.status === 200) {
                                    let data = xhr.response;
                                    console.log(data);
                                }
                            }
                        }
                        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        xhr.send("code=" + code + "&email=" + emval);

                    } else {
                        console.log('Match - Phone');
                    }
                }
                else {
                    console.log('Match - Email');
                }
            }
        }

        async function signup() {
            if (subva() == true) {
                let checkEm = await checkEmail();
                let checkPh = await checkPhone();
                console.log("checkEm - " + checkEm + typeof checkEm);
                console.log("checkPh - " + checkPh + typeof checkPh);
                if (checkEm == true) {
                    if (checkPh == true) {
                        userreg = '';
                        unval = document.getElementById('username').value;
                        uaval = document.getElementById('useradd').value;
                        userreg = document.getElementById('userreg').value;
                        moval = document.getElementById('mono').value;
                        emval = document.getElementById('email').value;
                        psdval = document.getElementById('password').value;
                        cpsdval = document.getElementById('cpassword').value;
                        signInAnonymously(auth)
                            .then((userCredential) => {
                                //user.uid  
                                set(ref(database, 'rfid/users/' + moval), {
                                    username: unval,
                                    address: uaval,
                                    userreg: userreg,
                                    phone: moval,
                                    email: emval,
                                    password: psdval
                                }).then((success) => {
                                    alert("Data Added Successfully");
                                }).catch((error) => {
                                    alert("Data couldn't be Added !!");
                                });
                            })
                            .catch((error) => {
                                var errorCode = error.code;
                                var errorMessage = error.message;
                                alert("Error Code - " + errorCode);
                                alert("Error Message - " + errorMessage);
                            });
                    }
                    else {
                        console.log('Match - Phone');
                    }
                }
                else {
                    console.log('Match - Email');
                }
            }
        }
        const button = document.getElementById("submit");
        if (button != null) {
            button.addEventListener("click", sendOTP);
        }
    </script>
    <script src="js/rfid.js"></script>

</head>
<style>

</style>

<body>


    <section class="ftco-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-12 col-lg-10">
                    <div class="wrap d-md-flex">
                        <div class="text-wrap p-4 p-lg-5 text-center d-flex align-items-center order-md-last">
                            <div class="text w-100">
                                <h2>RFID Attendance</h2>
                                <p>Already have an account?</p>
                                <a href="./" class="btn btn-white btn-outline-white">Log In</a>
                            </div>
                        </div>
                        <div class="login-wrap p-4 p-lg-5 otpsection">
                            <div class="d-flex">
                                <div class="w-100">
                                    <h3 class="mb-4">OTP</h3>
                                </div>

                            </div>
                            <form action="signup.php" enctype="multipart/form-data" method="POST" autocomplete="off"
                                onsubmit="return otpva()">


                                <div class="form-group mb-3">
                                    <label class="label" for="name">Confirm OTP</label>
                                    <input type="number" class="form-control" placeholder="OTP Number" id="ono"
                                        name="ono" max="99999999" min="10000000" autocomplete="off" onchange="ova()">
                                    <span id="ospan" class="err"></span>
                                    <span id="ospans" class="suc"></span>
                                </div>


                                <div class="form-group">
                                    <input type="submit" class="form-control btn btn-primary submit px-3"
                                        value="Confirm OTP" id="confirm" name="confirm"><span id="otperr"
                                        class="errr"></span>
                                </div>
                            </form>
                        </div>

                        <div class="login-wrap p-4 p-lg-5">
                            <div class="d-flex">
                                <div class="w-100">
                                    <h3 class="mb-4">Sign Up</h3>
                                </div>

                            </div>


                            <div class="form-group mb-3">
                                <label class="label" for="name">Full Name *</label>
                                <input type="text" class="form-control" placeholder="Full Name" id="username"
                                    name="username" maxlength="45" autocomplete="off" onkeyup="lettersOnly(this)"
                                    onchange="unva()">
                                <span id="userspan" class="err"></span>
                                <span id="userspans" class="suc"></span>
                            </div>
                            <div class="form-group mb-3">
                                <label class="label" for="name">Registration Number</label>
                                <input type="text" class="form-control" placeholder="Only For Students" id="userreg"
                                    name="userreg" maxlength="45" autocomplete="off" onkeyup="charOnlyreg(this)">
                                <span id="userregspan" class="err"></span>
                                <span id="userregspans" class="suc"></span>
                            </div>
                            <div class="form-group mb-3">
                                <label class="label" for="name">Phone with Country Code *</label>
                                <input type="number" class="form-control" placeholder="eg. 91**********" id="mono"
                                    name="number" autocomplete="off" onchange="mova()">
                                <span id="mospan" class="err"></span>
                                <span id="mospans" class="suc"></span>
                            </div>

                            <div class="form-group mb-3">
                                <label class="label" for="name">Address *</label>
                                <input type="text" class="form-control" placeholder="Current Address" id="useradd"
                                    name="useradd" maxlength="45" autocomplete="off" onchange="uava()">
                                <span id="useraddspan" class="err"></span>
                                <span id="useraddspans" class="suc"></span>
                            </div>
                            <div class="form-group mb-3">
                                <label class="label" for="name">Email *</label>
                                <input type="email" class="form-control" placeholder="Email (To send OTP)" id="email"
                                    name="email" onkeyup="charOnly(this)" maxlength="35" autocomplete="off"
                                    onchange="emva()">
                                <span id="emailspan" class="err"></span>
                                <span id="emailspans" class="suc"></span>
                            </div>
                            <div class="form-group mb-3">
                                <label class="label" for="password">Password *</label>
                                <input type="password" class="form-control" placeholder="Password" id="password"
                                    name="password" onkeyup="charOnly(this)" maxlength="25" autocomplete="off"
                                    onchange="pdva()">
                                <span id="psdspan" class="err"></span>
                                <span id="psdspans" class="suc"></span>
                            </div>
                            <div class="form-group mb-3">
                                <label class="label" for="password">Confirm Password *</label>
                                <input type="password" class="form-control" placeholder="Confirm Password"
                                    id="cpassword" name="cpassword" onkeyup="charOnly(this)" maxlength="25"
                                    autocomplete="off" onchange="cpdva()">
                                <span id="cpsdspan" class="err"></span>
                                <span id="cpsdspans" class="suc"></span>
                            </div>
                            <div class="form-group">
                                <button class="form-control btn btn-primary submit px-3" id="submit" name="submit">Sign
                                    Up</button>
                                <!-- <input type="submit" class="form-control btn btn-primary submit px-3" value="Sign Up"
                                    id="submit" name="submit"> -->
                                <span id="suberr" class="errr"></span>
                            </div>
                            <div class="w-100 text-md-right">
                                * Required
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>

</body>

</html>